#!/usr/bin/env bash
echo "*** Rebuild Tethys_in_Docker ***"
SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
cd $SCRIPT_DIR

if [  $# -eq 0 ]
then
    branch_name=release-candidate-140-1
else
    branch_name=$1
fi

echo "Remove existing containers...."
docker stop $(docker ps -a -q -f name=tethys_in_docker*)
docker rm -f $(docker ps -a -q -f name=tethys_in_docker*)
#docker rmi -f $(docker images | grep tethys_in_docker)

# remove all unused data volumes
echo "Remove unused data volumes...."
docker volume rm $(docker volume ls -qf dangling=true)

# create required folders
rm -rf tethys
rm -rf static
mkdir -p static

echo "Clone Tethys repo...."
git clone https://github.com/tethysplatform/tethys.git
cd tethys
echo "Using branch " $branch_name
git checkout $branch_name
cd ..
cp -f tethys/requirements.txt tethys_main/

echo "Build images...."
docker-compose build
echo "Start containers...."
docker-compose up -d
wait
sleep 10
echo "Migrate DB...."
#docker-compose run --rm tethys_in_docker_main bash -c "/bin/bash build-tethys && \
#                                                       python manage.py migrate && \
#                                                       python manage.py createsuperuser"

docker exec -it tethys_in_docker_main bash -c "/bin/bash build-tethys && \
                                                       python manage.py migrate && \
                                                       python manage.py collectstatic --noinput && \
                                                       python manage.py createsuperuser"
# docker exec -it tethys_in_docker_main python manage.py migrate
# docker exec -it tethys_in_docker_main python manage.py createsuperuser
echo "Restart containers...."
docker restart tethys_in_docker_main
wait
echo "Done. Visit 127.0.0.1:8000"